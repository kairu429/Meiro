<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Maze - Multiplayer Battle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'sans-serif'; touch-action: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .pointer-auto { pointer-events: auto; }
        canvas { display: block; }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 2px; }
        
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            padding: 0;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 2px solid #ddd; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="ui-layer" class="flex flex-col items-center justify-center p-4">
    <!-- ÂàùÊúüÂÖ•ÂäõÁîªÈù¢ -->
    <div id="start-menu" class="pointer-auto bg-white/90 p-8 rounded-2xl shadow-2xl text-center max-w-md w-full overflow-y-auto max-h-[90vh]">
        <h1 class="text-3xl font-bold mb-2 text-gray-800">3DËø∑Ë∑Ø„Éû„É´„ÉÅ</h1>
        <p class="text-xs text-blue-600 mb-4 font-bold" id="auth-status">Ë™çË®º„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö‰∏≠...</p>
        
        <div class="text-left mb-6 space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">„Éó„É¨„Ç§„É§„ÉºÂêç</label>
                <div class="flex gap-2">
                    <input type="text" id="username-input" placeholder="„Ç≤„Çπ„Éà" class="flex-1 p-2 border-2 border-blue-500 rounded-lg text-center focus:outline-none bg-white font-bold text-gray-700">
                    <button id="random-name-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform active:scale-95 text-sm whitespace-nowrap">
                        üé≤ „É©„É≥„ÉÄ„É†
                    </button>
                </div>
            </div>

            <div class="bg-gray-100 p-4 rounded-lg">
                <h3 class="font-bold text-sm text-gray-700 mb-3 border-b pb-1">„Ç¢„Éê„Çø„ÉºÁùÄ„ÅõÊõø„Åà</h3>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <label class="block text-xs text-gray-500 mb-1">Â∏ΩÂ≠ê</label>
                        <input type="color" id="color-hat" value="#ff0000">
                    </div>
                    <div class="text-center">
                        <label class="block text-xs text-gray-500 mb-1">Êúç</label>
                        <input type="color" id="color-shirt" value="#3b82f6">
                    </div>
                    <div class="text-center">
                        <label class="block text-xs text-gray-500 mb-1">„Ç∫„Éú„É≥</label>
                        <input type="color" id="color-pants" value="#22c55e">
                    </div>
                </div>
            </div>
        </div>

        <button id="start-btn" disabled class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition-all text-xl cursor-not-allowed shadow-md">
            Êé•Á∂ö„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
        </button>
        <p class="text-[10px] text-gray-400 mt-4">‚ÄªFirebase„Å´„Çà„Çã„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü„ÅåÊúâÂäπ„Åß„Åô</p>
    </div>

    <!-- „Ç≤„Éº„É†‰∏≠UI -->
    <div id="game-ui" class="hidden w-full h-full flex flex-col justify-between pointer-events-none">
        <div class="p-4 flex justify-between items-start pointer-auto">
            <div class="flex flex-col gap-2">
                <div class="bg-black/50 text-white p-3 rounded-lg backdrop-blur-md text-sm shadow-lg">
                    ID: <span id="display-id" class="font-mono text-xs">----</span>
                </div>
            </div>
            <div class="flex flex-col gap-2 items-end">
                <button id="view-toggle-btn" class="bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-lg text-xs shadow-lg">Ë¶ñÁÇπÂàáÊõø</button>
            </div>
        </div>

        <!-- „ÉÅ„É£„ÉÉ„ÉàUI -->
        <div class="absolute bottom-32 left-4 w-72 pointer-auto flex flex-col gap-2">
            <div id="chat-messages" class="h-40 overflow-y-auto bg-black/40 backdrop-blur-sm rounded-lg p-2 text-xs text-white flex flex-col gap-1 shadow-lg border border-white/10"></div>
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." class="flex-1 bg-black/60 text-white border border-white/30 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-400 transition-colors">
                <button id="chat-send" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-transform active:scale-95">ÈÄÅ‰ø°</button>
            </div>
        </div>
        
        <!-- „Ç≥„É≥„Éà„É≠„Éº„É©„Éº -->
        <div class="flex justify-center mb-8 gap-4 pointer-auto">
             <div class="grid grid-cols-3 gap-2 opacity-60">
                <div></div>
                <button id="touch-up" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/50 text-2xl active:bg-white/40">‚Üë</button>
                <div></div>
                <button id="touch-left" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/50 text-2xl active:bg-white/40">‚Üê</button>
                <button id="touch-down" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/50 text-2xl active:bg-white/40">‚Üì</button>
                <button id="touch-right" class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border-2 border-white/50 text-2xl active:bg-white/40">‚Üí</button>
             </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

// --- Firebase Configuration ---
// CanvasÁí∞Â¢É„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ __firebase_config „ÇíÂÑ™ÂÖàÁöÑ„Å´‰ΩøÁî®„Åó„Åæ„Åô
const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config) 
    : {
        apiKey: "AIzaSyDOqBobe4ySp_kkoqbB1CeNly8WDzwXBMw",
        authDomain: "hu31-a6d5d.firebaseapp.com",
        projectId: "hu31-a6d5d",
        storageBucket: "hu31-a6d5d.firebasestorage.app",
        messagingSenderId: "942344504046",
        appId: "1:942344504046:web:a5ba492ea3aa3f0808e9ff"
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'maze-multi-live';

let currentUser = null;
let players = {}; 
let userName = "Guest";
let myOutfit = { hat: '#ff0000', shirt: '#3b82f6', pants: '#22c55e' };

// --- Random Name Generator ---
const NAME_PARTS = {
    part1: ["„ÇÑ„Çì„Å°„ÇÉ", "„ÇØ„Éº„É´", "„ÇØ„ÇªÂº∑", "ÂÄãÊÄßÁöÑ", "„Ç¢„Ç¶„Éà„É≠„Éº", "ÁÑ°Âè£", "ÈôΩ„Ç≠„É£", "Èô∞„Ç≠„É£", "„Éü„Çπ„ÉÜ„É™„Ç¢„Çπ", "Ëá™Áî±‰∫∫", "Á†¥Â§©Ëçí"],
    part2: ["„Å™", "„Çã", "ÁöÑ„Å™", "„ÅÆ", "Á≥ª", "Âºè", "È¢®", "„Å£„ÅΩ„ÅÑ"],
    part3: ["‰∏ÄËà¨‰∫∫", "„É©„ÉÉ„Éë„Éº", "„Ç≤„Éº„Éû„Éº", "„Éó„É≠„Ç∞„É©„Éû„Éº", "„Éè„ÉÉ„Ç´„Éº", "„Çπ„Éà„É™„Éº„Éû„Éº", "„ÇØ„É™„Ç®„Ç§„Çø„Éº", "Ë®≠Ë®àËÄÖ", "Êé¢Á¥¢ËÄÖ", "„Ç∑„Çπ„ÉÜ„É†Â±ã"]
};

function generateRandomName() {
    const p1 = NAME_PARTS.part1[Math.floor(Math.random() * NAME_PARTS.part1.length)];
    const p2 = NAME_PARTS.part2[Math.floor(Math.random() * NAME_PARTS.part2.length)];
    const p3 = NAME_PARTS.part3[Math.floor(Math.random() * NAME_PARTS.part3.length)];
    return p1 + p2 + p3;
}

// --- Game Engine Variables ---
let scene, camera, renderer, mazeGroup;
let player, clock;
let mazeData = [];
let mazeSize = 15;
let keys = { w: false, a: false, s: false, d: false, touchUp: false, touchDown: false, touchLeft: false, touchRight: false };
let isGameActive = false;
let isFirstPerson = false;
let cameraAngleTheta = Math.PI; 
let isMouseDown = false;
let mouseX = 0;

async function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f172a); 
    scene.fog = new THREE.Fog(0x0f172a, 5, 50);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 30, 10);
    dirLight.castShadow = true;
    scene.add(dirLight);

    clock = new THREE.Clock();

    window.addEventListener('resize', onWindowResize);
    window.addEventListener('mousedown', (e) => { 
        if(e.target.tagName !== 'INPUT') { isMouseDown = true; mouseX = e.clientX; }
    });
    window.addEventListener('mouseup', () => isMouseDown = false);
    window.addEventListener('mousemove', (e) => {
        if (!isMouseDown) return;
        cameraAngleTheta -= (e.clientX - mouseX) * 0.007;
        mouseX = e.clientX;
    });

    // Auth logic: RULE 3 - Auth Before Queries
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                console.log("Attempting Custom Token Auth...");
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                console.log("Attempting Anonymous Auth...");
                await signInAnonymously(auth);
            }
        } catch (err) {
            console.error("Auth Failed:", err);
            // „Ç®„É©„ÉºÊôÇ„Åß„ÇÇ„ÄÅ„ÇÇ„ÅóconfigË®≠ÂÆö„ÅÆ‰∏çÂÇô„Åß„ÅÇ„Çå„Å∞ÂåøÂêç„É≠„Ç∞„Ç§„É≥„ÇíÂÜçË©¶Ë°å
            if (err.code === 'auth/configuration-not-found') {
                document.getElementById('auth-status').innerText = "Ë™çË®ºË®≠ÂÆö„Ç®„É©„Éº: ÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                document.getElementById('auth-status').classList.add('text-red-500');
            }
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-status').innerText = "„Ç™„É≥„É©„Ç§„É≥: ÂêåÊúüÊ∫ñÂÇôÂÆå‰∫Ü";
            document.getElementById('auth-status').classList.remove('text-blue-600', 'text-red-500');
            document.getElementById('auth-status').classList.add('text-green-600');
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').innerText = "Ëø∑Ë∑Ø„Å´ÂÖ•„Çã";
            document.getElementById('start-btn').classList.remove('bg-gray-400', 'cursor-not-allowed');
            document.getElementById('start-btn').classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('display-id').innerText = user.uid; // Complete UID
            setupMultiplayerListeners();
        }
    });

    await initAuth();
}

function generateFixedMaze() {
    mazeSize = 15;
    mazeData = Array.from({ length: mazeSize }, () => Array(mazeSize).fill(1));
    for(let i=1; i<mazeSize-1; i++) {
        for(let j=1; j<mazeSize-1; j++) {
            if(i%2!==0 && j%2!==0) mazeData[i][j] = 0;
            if(i%2!==0 && j%2==0 && Math.sin(i*j) > 0) mazeData[i][j] = 0;
            if(i%2==0 && j%2!==0 && Math.cos(i+j) > 0) mazeData[i][j] = 0;
        }
    }
}

function build3DMaze() {
    if (mazeGroup) scene.remove(mazeGroup);
    mazeGroup = new THREE.Group();
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x334155 });
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x020617 });
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(mazeSize, mazeSize), floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.set(mazeSize / 2 - 0.5, 0, mazeSize / 2 - 0.5);
    floor.receiveShadow = true;
    mazeGroup.add(floor);

    const wallGeo = new THREE.BoxGeometry(1, 2, 1);
    for (let y = 0; y < mazeSize; y++) {
        for (let x = 0; x < mazeSize; x++) {
            if (mazeData[y][x] === 1) {
                const wall = new THREE.Mesh(wallGeo, wallMat);
                wall.position.set(x, 1, y);
                wall.castShadow = true;
                wall.receiveShadow = true;
                mazeGroup.add(wall);
            }
        }
    }
    scene.add(mazeGroup);
}

function createCharacter(outfit, name) {
    const group = new THREE.Group();
    const shirtMat = new THREE.MeshStandardMaterial({ color: outfit?.shirt || 0x3b82f6 });
    const pantsMat = new THREE.MeshStandardMaterial({ color: outfit?.pants || 0x22c55e });
    const skinMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.6, 0.2), shirtMat);
    body.position.y = 0.6;
    body.castShadow = true;
    group.add(body);
    
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.25, 0.25), skinMat);
    head.position.y = 1.05;
    head.castShadow = true;
    group.add(head);

    const hatMat = new THREE.MeshStandardMaterial({ color: outfit?.hat || 0xff0000 });
    const hatBase = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.1, 16), hatMat);
    hatBase.position.y = 1.2;
    group.add(hatBase);
    
    // Name Tag
    const canvas = document.createElement('canvas');
    canvas.width = 256; canvas.height = 64; 
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.roundRect(0, 0, 256, 64, 15);
    ctx.fill();
    ctx.fillStyle = 'white'; 
    ctx.font = 'bold 32px sans-serif';
    ctx.textAlign = 'center'; 
    ctx.textBaseline = 'middle';
    ctx.fillText(name || "Player", 128, 32);
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    sprite.position.y = 1.5;
    sprite.scale.set(0.6, 0.15, 1); 
    group.add(sprite);

    group.leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.4, 0.12), pantsMat);
    group.leftLeg.position.set(-0.1, 0.2, 0);
    group.add(group.leftLeg);
    
    group.rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.4, 0.12), pantsMat);
    group.rightLeg.position.set(0.1, 0.2, 0);
    group.add(group.rightLeg);

    group.bubbleContainer = new THREE.Group();
    group.bubbleContainer.position.set(0, 1.8, 0);
    group.add(group.bubbleContainer);

    return group;
}

function showChatBubble(charGroup, text) {
    if (!charGroup || !charGroup.bubbleContainer) return;
    while(charGroup.bubbleContainer.children.length > 0) charGroup.bubbleContainer.remove(charGroup.bubbleContainer.children[0]);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = '24px sans-serif';
    const textWidth = ctx.measureText(text).width;
    canvas.width = Math.max(128, textWidth + 40);
    canvas.height = 64;
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.roundRect(0, 0, canvas.width, 50, 10); ctx.fill();
    ctx.beginPath(); ctx.moveTo(canvas.width/2-10, 50); ctx.lineTo(canvas.width/2, 60); ctx.lineTo(canvas.width/2+10, 50); ctx.fill();
    ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.fillText(text, canvas.width/2, 35);

    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    const aspect = canvas.width / 64;
    sprite.scale.set(0.3 * aspect, 0.3, 1); 
    charGroup.bubbleContainer.add(sprite);
    setTimeout(() => { if(charGroup && charGroup.bubbleContainer) charGroup.bubbleContainer.remove(sprite); }, 5000);
}

function setupMultiplayerListeners() {
    if (!currentUser) return;
    // RULE 1: Strict Paths
    const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
    onSnapshot(playersRef, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const data = change.doc.data();
            const id = change.doc.id;
            if (id === currentUser.uid) return;
            if (change.type === "added" || change.type === "modified") {
                if (!players[id]) {
                    players[id] = createCharacter(data.outfit, data.name);
                    scene.add(players[id]);
                }
                players[id].position.set(data.x, 0, data.z);
                players[id].rotation.y = data.rot;
            }
            if (change.type === "removed") {
                if (players[id]) { scene.remove(players[id]); delete players[id]; }
            }
        });
    }, (error) => console.error("Firestore Players Sync Error:", error));

    const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');
    onSnapshot(chatRef, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                const div = document.createElement('div');
                div.innerHTML = `<span class="font-bold text-blue-400">${data.sender}:</span> ${data.text}`;
                document.getElementById('chat-messages').appendChild(div);
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                if (data.uid === currentUser?.uid) showChatBubble(player, data.text);
                else if (players[data.uid]) showChatBubble(players[data.uid], data.text);
            }
        });
    }, (error) => console.error("Firestore Chat Sync Error:", error));
}

async function updateMyPosition() {
    if (!currentUser || !isGameActive || !player) return;
    try {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', currentUser.uid), {
            x: player.position.x, z: player.position.z, rot: player.rotation.y,
            name: userName, outfit: myOutfit, lastSeen: serverTimestamp()
        }, { merge: true });
    } catch(e) { console.error("Update Pos Error:", e); }
}

function animate() {
    requestAnimationFrame(animate);
    const delta = clock ? Math.min(clock.getDelta(), 0.1) : 0.016;
    if (isGameActive && player) {
        let ix = 0, iz = 0;
        if (keys.w || keys.touchUp) iz -= 1; if (keys.s || keys.touchDown) iz += 1;
        if (keys.a || keys.touchLeft) ix -= 1; if (keys.d || keys.touchRight) ix += 1;
        if (ix !== 0 || iz !== 0) {
            const moveDir = cameraAngleTheta + Math.atan2(ix, iz);
            const vx = Math.sin(moveDir) * 5.0 * delta;
            const vz = Math.cos(moveDir) * 5.0 * delta;
            if (!checkWall(player.position.x + vx, player.position.z)) player.position.x += vx;
            if (!checkWall(player.position.x, player.position.z + vz)) player.position.z += vz;
            player.rotation.y = moveDir;
            player.leftLeg.rotation.x = Math.sin(Date.now()*0.012) * 0.6;
            player.rightLeg.rotation.x = -Math.sin(Date.now()*0.012) * 0.6;
            if (Math.random() > 0.8) updateMyPosition();
        }
        if (isFirstPerson) {
            camera.position.set(player.position.x, 1.0, player.position.z);
            camera.lookAt(player.position.x + Math.sin(cameraAngleTheta+Math.PI), 1.0, player.position.z + Math.cos(cameraAngleTheta+Math.PI));
        } else {
            camera.position.set(player.position.x + 3 * Math.sin(cameraAngleTheta), 4, player.position.z + 3 * Math.cos(cameraAngleTheta));
            camera.lookAt(player.position.x, 0.5, player.position.z);
        }
    }
    renderer.render(scene, camera);
}

function checkWall(nx, nz) {
    const gx = Math.round(nx), gy = Math.round(nz);
    return gx < 0 || gx >= mazeSize || gy < 0 || gy >= mazeSize || mazeData[gy][gx] === 1;
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

document.getElementById('random-name-btn').onclick = () => document.getElementById('username-input').value = generateRandomName();
document.getElementById('start-btn').onclick = () => {
    userName = document.getElementById('username-input').value || "Guest";
    myOutfit = { hat: document.getElementById('color-hat').value, shirt: document.getElementById('color-shirt').value, pants: document.getElementById('color-pants').value };
    document.getElementById('start-menu').classList.add('hidden'); document.getElementById('game-ui').classList.remove('hidden');
    generateFixedMaze(); build3DMaze();
    player = createCharacter(myOutfit, userName); player.position.set(1, 0, 1); scene.add(player);
    isGameActive = true; updateMyPosition();
};
document.getElementById('chat-send').onclick = async () => {
    const input = document.getElementById('chat-input'); const val = input.value.trim();
    if (!val || !currentUser) return; input.value = "";
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), { uid: currentUser.uid, sender: userName, text: val, createdAt: serverTimestamp() });
};
document.getElementById('view-toggle-btn').onclick = () => isFirstPerson = !isFirstPerson;

window.onkeydown = (e) => { const k = e.key.toLowerCase(); if (k==='w') keys.w=true; if (k==='s') keys.s=true; if (k==='a') keys.a=true; if (k==='d') keys.d=true; };
window.onkeyup = (e) => { const k = e.key.toLowerCase(); if (k==='w') keys.w=false; if (k==='s') keys.s=false; if (k==='a') keys.a=false; if (k==='d') keys.d=false; };
const st = (id, k) => { const el = document.getElementById(id); el.ontouchstart = (e) => { e.preventDefault(); keys[k]=true; }; el.ontouchend = () => keys[k]=false; };
st('touch-up', 'touchUp'); st('touch-down', 'touchDown'); st('touch-left', 'touchLeft'); st('touch-right', 'touchRight');

window.onload = () => {
    init(); animate();
};
</script>
</body>
</html>
